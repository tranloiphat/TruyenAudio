<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="_fragments :: head(${ 'Chapter ' + chapter.tenChapter + ' - ' + chapter.boTruyen.tenTruyen })"></head>
<body>
<div th:replace="_fragments :: header"></div>

<div class="container">
  <div class="breadcrumbs">
    <a th:href="@{/}">Trang chủ</a> ›
    <a th:href="@{/botruyen}">Bộ truyện</a> ›
    <a th:href="@{/botruyen/{id}(id=${chapter.boTruyen.boTruyenId})}"
       th:text="${chapter.boTruyen.tenTruyen}">Bộ truyện</a> ›
    <b th:text="${'Chapter ' + chapter.tenChapter}">Chapter</b>
  </div>
</div>

<div class="reader-top">
  <div class="container" style="padding:8px 0">
    <div class="row" style="gap:8px">
      <a class="btn" id="prevBtn">← Chap trước</a>
      <a class="btn" id="nextBtn">Chap sau →</a>

      <select id="chapSelect" class="select" style="min-width:200px">
        <option th:each="c : ${chapter.boTruyen.chapters}"
                th:selected="${c.chapterId == chapter.chapterId}"
                th:value="${c.chapterId}"
                th:text="${'Chapter ' + c.tenChapter}"></option>
      </select>

      <span style="margin-left:auto"></span>
      <button class="btn" onclick="zoom(-0.1)">-</button>
      <span class="muted">Zoom</span>
      <input id="zoomRange" type="range" min="0.5" max="2.0" step="0.1" value="1.0" oninput="applyScale()">
      <button class="btn" onclick="zoom(+0.1)">+</button>

      <a class="btn" th:href="@{/chapter/file/{f}(f=${chapter.pdfFile})}" target="_blank">Mở PDF</a>
    </div>
  </div>
</div>

<div class="container">
  <div class="reader" id="viewer"
       th:attr="data-pdf=@{/chapter/file/{f}(f=${chapter.pdfFile})}"></div>
</div>

<div th:replace="_fragments :: footer"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  const pdfUrl = document.getElementById('viewer').dataset.pdf;
  const zoomRange = document.getElementById('zoomRange');
  let pdfDoc=null, scale=parseFloat(zoomRange.value), canvases=[];
  pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  async function loadPdf(){
    pdfDoc = await pdfjsLib.getDocument(pdfUrl).promise;
    const viewer = document.getElementById('viewer');
    viewer.innerHTML = ""; canvases=[];
    for(let p=1;p<=pdfDoc.numPages;p++){
      const page = await pdfDoc.getPage(p);
      const viewport = page.getViewport({scale});
      const c = document.createElement('canvas'); c.width=viewport.width; c.height=viewport.height;
      viewer.appendChild(c); canvases.push(c);
      await page.render({canvasContext:c.getContext('2d'), viewport}).promise;
    }
  }
  function applyScale(){ scale=parseFloat(zoomRange.value); rerender(); }
  function zoom(delta){ zoomRange.value=Math.max(0.5,Math.min(2.0,parseFloat(zoomRange.value)+delta)); applyScale(); }
  async function rerender(){
    if(!pdfDoc) return;
    for(let i=0;i<canvases.length;i++){
      const page = await pdfDoc.getPage(i+1);
      const vp = page.getViewport({scale});
      const c = canvases[i]; c.width=vp.width; c.height=vp.height;
      await page.render({canvasContext:c.getContext('2d'), viewport:vp}).promise;
    }
  }

  // Điều hướng chap
  (function initNav(){
    const sel = document.getElementById('chapSelect');
    sel.addEventListener('change', e=> window.location.href = '/chapter/' + e.target.value);
    const opts=[...sel.options]; const idx = opts.findIndex(o=>o.selected);
    const prev = idx>0 ? opts[idx-1].value : null;
    const next = idx<opts.length-1 ? opts[idx+1].value : null;
    const prevBtn=document.getElementById('prevBtn'), nextBtn=document.getElementById('nextBtn');
    if(prev){ prevBtn.href='/chapter/'+prev; } else { prevBtn.classList.add('muted'); prevBtn.removeAttribute('href'); }
    if(next){ nextBtn.href='/chapter/'+next; } else { nextBtn.classList.add('muted'); nextBtn.removeAttribute('href'); }
  })();

  loadPdf().catch(()=>alert('Không tải được PDF.'));
</script>
</body>
</html>
