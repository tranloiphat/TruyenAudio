<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="_fragments :: head(${boTruyen.tenTruyen})"></head>
<body>
<div th:replace="_fragments :: header"></div>

<div class="container">
    <div class="breadcrumbs">
        <a th:href="@{/}">Trang chủ</a> › <a th:href="@{/botruyen}">Bộ truyện</a> ›
        <b th:text="${boTruyen.tenTruyen}">Tên</b>
    </div>

    <section class="row" style="gap:24px;align-items:flex-start">
        <div style="width:220px;flex:0 0 auto">
            <img class="thumb" th:if="${boTruyen.image != null}" th:src="@{${'/uploads/' + boTruyen.image}}" alt="">
            <div class="thumb" th:if="${boTruyen.image == null}"></div>
        </div>
        <div style="flex:1">
            <h1 style="margin:0 0 8px" th:text="${boTruyen.tenTruyen}">Tên bộ truyện</h1>
            <div class="row">
                <span class="badge" th:text="${boTruyen.trangThai} ?: 'Đang phát hành'">Đang phát hành</span>
                <span class="muted">Phát hành:
          <b th:text="${#temporals.format(boTruyen.thoiGianPhatHanh,'dd/MM/yyyy')}">--</b>
        </span>
            </div>
            <p style="margin-top:10px" th:text="${boTruyen.moTaNgan}"></p>
            <p class="muted" th:text="${boTruyen.moTaDai}"></p>

            <div class="row" style="margin-top:8px">
                <a id="firstRead" class="btn btn-primary" href="#">Đọc từ chap đầu</a>
                <a id="lastRead" class="btn" href="#">Đọc chap mới nhất</a>
                <a class="btn" th:href="@{/chapter/add}">+ Thêm Chapter</a>
                <a class="btn" th:href="@{/botruyen/edit/{id}(id=${boTruyen.boTruyenId})}">Sửa bộ truyện</a>
                <form th:action="@{/botruyen/delete/{id}(id=${boTruyen.boTruyenId})}" method="post" style="display:inline">
                    <!-- CSRF nếu dùng:
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    -->
                    <button type="submit" class="btn" style="border-color:#7f1d1d;background:#451a1a"
                            onclick="return confirm('Xoá bộ truyện này và toàn bộ chapter?')">Xoá</button>
                </form>
            </div>
        </div>
    </section>

    <h2 style="margin:24px 0 10px">Danh sách chapter</h2>
    <div class="row" style="justify-content:space-between;margin-bottom:10px">
        <div class="row">
            <label for="sortChap">Sắp xếp</label>
            <select id="sortChap" class="select">
                <option value="asc">Tăng dần (1→N)</option>
                <option value="desc">Giảm dần (N→1)</option>
            </select>
        </div>
        <div class="row">
            <label>Tìm chap</label>
            <input id="searchChap" class="select" placeholder="Nhập số chap...">
        </div>
    </div>

    <div id="chapList" class="grid grid-sm-2 grid-lg-3">
        <div class="card" style="padding:12px;display:flex;justify-content:space-between;align-items:center"
             th:each="c : ${chapters}"
             th:attr="data-stt=${c.tenChapter},data-id=${c.chapterId}">
            <a th:href="@{/chapter/{id}(id=${c.chapterId})}">
                <b th:text="'Chapter ' + ${c.tenChapter}">Chapter</b>
            </a>
            <div class="row">
                <a class="btn" th:href="@{/chapter/edit/{id}(id=${c.chapterId})}">Sửa</a>
                <form th:action="@{/chapter/delete/{id}(id=${c.chapterId})}" method="post" style="display:inline">
                    <!-- CSRF nếu dùng:
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    -->
                    <button type="submit" class="btn" style="border-color:#7f1d1d;background:#451a1a"
                            onclick="return confirm('Xoá chapter này?')">Xoá</button>
                </form>
            </div>
            <div class="wrap" style="margin-top:8px">
                <a class="pill"
                   th:each="tl : ${boTruyen.theLoais}"
                   th:href="@{/theloai/{id}(id=${tl.theLoaiId})}"
                   th:text="${tl.tenTheLoai}">Thể loại</a>
                <span class="muted" th:if="${#lists.isEmpty(boTruyen.theLoais)}">Chưa gán thể loại</span>
            </div>

        </div>
        <div th:if="${#lists.isEmpty(chapters)}" class="muted">Chưa có chapter nào.</div>
    </div>
    <div class="wrap" style="margin-top:8px">
        <a class="pill"
           th:each="tl : ${genres}"
           th:href="@{/theloai/{id}(id=${tl.theLoaiId})}"
           th:text="${tl.tenTheLoai}">Thể loại</a>
        <span class="muted" th:if="${#lists.isEmpty(genres)}">Chưa gán thể loại</span>
    </div>
</div>

<div th:replace="_fragments :: footer"></div>

<script>
    const list = document.getElementById('chapList');
    const sortSel = document.getElementById('sortChap');
    const search = document.getElementById('searchChap');

    function sortChaps(dir){
        const items = [...list.querySelectorAll('.card')];
        items.sort((a,b)=>{
            const ca = parseInt(a.dataset.stt||'0',10);
            const cb = parseInt(b.dataset.stt||'0',10);
            return dir==='asc' ? (ca-cb) : (cb-ca);
        });
        items.forEach(i=>list.appendChild(i));
    }
    function filterChaps(q){
        q = (q||'').trim();
        [...list.querySelectorAll('.card')].forEach(card=>{
            const stt = (card.dataset.stt||'');
            card.style.display = stt.includes(q) ? '' : 'none';
        });
    }
    function wireFirstLast(){
        const cards = [...list.querySelectorAll('.card')];
        if(cards.length===0) return;
        const sorted = cards.slice().sort((a,b)=>parseInt(a.dataset.stt||'0')-parseInt(b.dataset.stt||'0'));
        const first = sorted[0], last = sorted[sorted.length-1];
        document.getElementById('firstRead').href = '/chapter/' + first.dataset.id;
        document.getElementById('lastRead').href  = '/chapter/' + last.dataset.id;
    }

    sortSel.addEventListener('change', ()=> sortChaps(sortSel.value));
    search.addEventListener('input', ()=> filterChaps(search.value));

    sortChaps('asc');
    wireFirstLast();
</script>
</body>
</html>
